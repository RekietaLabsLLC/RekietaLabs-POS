<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RekietaLabs POS - Loading</title>
  <link rel="icon" href="IMG_0926.jpeg" type="image/jpeg">
  <style>
    :root {
      --brand-color: #1753aa;
      --bg-color: #0a0a0a;
      --text-color: #ffffff;
      --input-bg: #111111;
      --input-border: #1753aa;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }

    h1, h2, h3 {
      color: var(--brand-color);
    }

    .hidden { display: none; }

    input, button {
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--brand-color);
      font-size: 16px;
    }

    button { cursor: pointer; transition: 0.2s; }
    button:hover { background: var(--brand-color); color: var(--bg-color); }

    #products {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      width: 90%;
      max-width: 800px;
      margin-top: 20px;
    }

    .product-btn {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--brand-color);
      background: var(--input-bg);
      color: var(--brand-color);
      font-weight: bold;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 80px;
      transition: 0.2s;
    }

    .product-btn:hover {
      background: var(--brand-color);
      color: var(--bg-color);
    }

    #cart {
      margin-top: 20px;
      width: 90%;
      max-width: 400px;
      border: 1px solid var(--brand-color);
      padding: 10px;
      border-radius: 8px;
      background: #111;
    }

    .cart-item {
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
    }

    #checkout-screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--brand-color);
      z-index: 1000;
    }

    #checkout-screen.hidden { display: none; }

    #checkout-screen input {
      margin: 10px;
      width: 250px;
    }

    #loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: var(--bg-color);
    }

    #loading-logo {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      border: 5px solid var(--brand-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: bold;
      color: var(--brand-color);
      animation: spin 2s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #signout-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--bg-color);
      border: 1px solid var(--brand-color);
    }

  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen">
    <div id="loading-logo">R</div>
    <h1>Welcome to RekietaLabs POS</h1>
    <h3>System Loading...</h3>
  </div>

  <!-- PIN Screen -->
  <div id="pin-screen" class="hidden">
    <h2>Enter Employee PIN</h2>
    <input type="password" id="pin-input" placeholder="Enter PIN">
    <button onclick="login()">Login</button>
    <p id="pin-error" style="color:red;"></p>
  </div>

  <!-- POS Screen -->
  <div id="pos-screen" class="hidden">
    <button id="signout-btn" onclick="signOut()">Sign Out</button>
    <h2>Products</h2>
    <div id="products"></div>

    <h2>Cart</h2>
    <div id="cart"></div>

    <button onclick="openCheckout()">Checkout</button>
  </div>

  <!-- Checkout Modal -->
  <div id="checkout-screen" class="hidden">
    <h2>Checkout</h2>
    <label>Email (optional): <input type="email" id="customer-email" placeholder="Customer Email"></label><br>
    <button onclick="finishCheckout('Card')">üí≥ Card</button>
    <button onclick="finishCheckout('Cash')">üíµ Cash</button>
    <button onclick="cancelCheckout()">Cancel</button>
    <p id="checkout-result"></p>
  </div>

<script>
  const API_BASE = window.location.hostname.includes("localhost")
    ? "http://localhost:10000"
    : "https://api.rekietalabs.com";

  let stock = [];
  let cart = [];

  const pins = ["7606", "4646"];

  // --- Load POS ---
  window.onload = () => {
    setTimeout(() => {
      document.getElementById("loading-screen").classList.add("hidden");
      document.getElementById("pin-screen").classList.remove("hidden");
      document.title = "RekietaLabs POS - Login";
    }, 3000);
  };

  async function login() {
    const pin = document.getElementById("pin-input").value;
    if (!pins.includes(pin)) {
      document.getElementById("pin-error").innerText = "Invalid PIN.";
      return;
    }
    document.getElementById("pin-screen").classList.add("hidden");
    document.getElementById("pos-screen").classList.remove("hidden");
    document.title = "RekietaLabs POS - Active";
    await loadStock();
    renderProducts();
  }

  function signOut() {
    cart = [];
    document.getElementById("pos-screen").classList.add("hidden");
    document.getElementById("pin-screen").classList.remove("hidden");
    document.title = "RekietaLabs POS - Login";
  }

  async function loadStock() {
    try {
      const res = await fetch(`${API_BASE}/pos-stock.json`);
      stock = await res.json();
    } catch(err) {
      alert("Error loading stock!");
      console.error(err);
    }
  }

  function renderProducts() {
    const container = document.getElementById("products");
    container.innerHTML = "";
    stock.forEach((item, idx) => {
      const btn = document.createElement("button");
      btn.className = "product-btn";
      btn.innerText = `${item.name}\n$${item.price.toFixed(2)} (${item.stock} left)`;
      btn.disabled = item.stock <= 0;
      btn.onclick = () => addToCart(idx);
      container.appendChild(btn);
    });
    renderCart();
  }

  function renderCart() {
    const container = document.getElementById("cart");
    container.innerHTML = "";
    cart.forEach(item => {
      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerText = `${item.name} x ${item.qty}`;
      container.appendChild(div);
    });
  }

  function addToCart(idx) {
    const product = stock[idx];
    if (product.stock <= 0) return alert("Out of stock!");
    const existing = cart.find(c => c.id === product.id);
    if (existing) existing.qty++;
    else cart.push({ id: product.id, name: product.name, price: product.price, qty: 1 });
    renderCart();
  }

  function openCheckout() {
    if (cart.length === 0) return alert("Cart is empty!");
    document.getElementById("checkout-screen").classList.remove("hidden");
    document.title = "RekietaLabs POS - Checkout";
  }

  function cancelCheckout() {
    document.getElementById("checkout-screen").classList.add("hidden");
    document.title = "RekietaLabs POS - Active";
  }

  async function finishCheckout(payment) {
    const email = document.getElementById("customer-email").value;
    try {
      const res = await fetch(`${API_BASE}/pos`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "checkout", items: cart, email, payment })
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById("checkout-result").innerHTML =
          `‚úÖ Success! <a href="${data.receiptUrl}" target="_blank">View Receipt</a>`;
        
        // Update local stock after successful checkout
        cart.forEach(item => {
          const prod = stock.find(p => p.id === item.id);
          if (prod) prod.stock -= item.qty;
        });

        cart = [];
        renderProducts();

        // Return to POS after 3s
        setTimeout(() => {
          document.getElementById("checkout-screen").classList.add("hidden");
          document.getElementById("customer-email").value = "";
          document.getElementById("checkout-result").innerText = "";
          document.title = "RekietaLabs POS - Active";
        }, 3000);
      } else {
        document.getElementById("checkout-result").innerText = "‚ùå " + data.message;
      }
    } catch (err) {
      document.getElementById("checkout-result").innerText = "Error contacting API.";
    }
  }
</script>
</body>
</html>
