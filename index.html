<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RekietaLabs POS</title>
<link rel="icon" href="https://rekietalabs.com/IMG_0926.jpeg" type="image/jpeg">
<style>
  body {
    font-family: Arial, sans-serif;
    background: #0a0a0a;
    color: #1753aa;
    margin: 0;
    padding: 0;
    text-align: center;
    overflow-x: hidden;
  }
  .screen {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.5s ease;
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .screen.active {
    opacity: 1;
    transform: translateY(0);
    position: relative;
  }
  input, button {
    padding: 10px;
    margin: 10px;
    border-radius: 8px;
    border: 1px solid #1753aa;
    background: #111;
    color: #1753aa;
    font-size: 16px;
    transition: transform 0.2s ease, background 0.3s ease;
  }
  button:hover {
    background: #1753aa;
    color: #fff;
    transform: scale(1.05);
  }
  #cart { margin-top: 20px; }
  .cart-item { margin: 5px 0; }
  .low-stock { color: #ff4444; font-weight: bold; }
  #logo {
    width: 120px;
    border-radius: 50%;
    margin-bottom: 20px;
    animation: rotateLogo 3s linear infinite;
  }
  @keyframes rotateLogo {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<div id="loading-screen" class="screen active">
  <img id="logo" src="https://rekietalabs.com/IMG_0926.jpeg" alt="RekietaLabs Logo">
  <h1>Welcome to RekietaLabs POS</h1>
  <h3>Loading system...</h3>
</div>

<div id="login-screen" class="screen">
  <h2>Enter Employee PIN</h2>
  <input type="password" id="pin-input" placeholder="Enter PIN">
  <div>
    <button onclick="login()">Login</button>
    <button onclick="signOut()">Sign Out</button>
  </div>
  <p id="pin-error" style="color:red;"></p>
</div>

<div id="pos-screen" class="screen">
  <h2>Products</h2>
  <div id="products"></div>
  <h2>Cart</h2>
  <div id="cart"></div>
  <div>
    <button onclick="checkout()">Checkout</button>
    <button onclick="signOut()">Sign Out</button>
  </div>
</div>

<div id="checkout-screen" class="screen">
  <h2>Checkout</h2>
  <div id="checkout-items"></div>
  <h3 id="checkout-total"></h3>
  <label>Email (optional): <input type="email" id="customer-email"></label><br>
  <div>
    <button onclick="finishCheckout('Card')">üí≥ Card</button>
    <button onclick="finishCheckout('Cash')">üíµ Cash</button>
    <button onclick="cancelCheckout()">Cancel</button>
  </div>
  <p id="checkout-result"></p>
</div>

<script>
const API_BASE = window.location.hostname.includes("localhost")
  ? "http://localhost:10000"
  : "https://api.rekietalabs.com";

let cart = [];
let stock = [];

// --- Startup ---
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    showScreen('login-screen');
  }, 2000);
});

// --- Screen Handling ---
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// --- Load Stock ---
async function loadStock() {
  try {
    const res = await fetch(`${API_BASE}/pos-stock`);
    stock = await res.json();
  } catch (err) {
    console.error(err);
    alert("Error loading stock!");
  }
}

// --- Login ---
async function login() {
  const pin = document.getElementById("pin-input").value;
  try {
    const res = await fetch(`${API_BASE}/pos`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "validate-pin", pin })
    });
    const data = await res.json();
    if(data.success) {
      cart = [];
      await loadStock();
      renderProducts();
      renderCart();
      document.getElementById("pin-input").value = "";
      showScreen('pos-screen');
    } else {
      document.getElementById("pin-error").innerText = "Invalid PIN.";
    }
  } catch (err) {
    document.getElementById("pin-error").innerText = "Error contacting API.";
  }
}

function signOut() {
  cart = [];
  stock = [];
  document.getElementById("pin-input").value = "";
  showScreen('login-screen');
}

// --- Products ---
function renderProducts() {
  const container = document.getElementById("products");
  container.innerHTML = "";
  stock.forEach((item, idx) => {
    const btn = document.createElement("button");
    btn.innerText = `${item.name} - $${item.price.toFixed(2)} (${item.stock} left)`;
    if(item.stock <= 1) btn.innerHTML += " ‚ö†Ô∏è<span class='low-stock'> Low!</span>";
    btn.onclick = () => addToCart(idx);
    container.appendChild(btn);
  });
}

// --- Cart ---
function addToCart(idx) {
  const item = stock[idx];
  if(item.stock <= 0) return alert("Out of stock!");
  item.stock -= 1;
  const existing = cart.find(c => c.name === item.name);
  if(existing) existing.qty++;
  else cart.push({ name: item.name, qty: 1, price: item.price });
  renderCart();
  renderProducts();
}

function renderCart() {
  const container = document.getElementById("cart");
  container.innerHTML = "";
  cart.forEach(item => {
    const div = document.createElement("div");
    div.className = "cart-item";
    div.innerText = `${item.name} x ${item.qty}`;
    container.appendChild(div);
  });
}

// --- Checkout ---
function checkout() {
  if(cart.length === 0) return alert("Cart is empty!");
  renderCheckoutItems();
  showScreen('checkout-screen');
}

function renderCheckoutItems() {
  const container = document.getElementById("checkout-items");
  container.innerHTML = "";
  let total = 0;
  cart.forEach(item => {
    total += item.price * item.qty;
    const div = document.createElement("div");
    div.innerText = `${item.name} x ${item.qty} - $${(item.price*item.qty).toFixed(2)}`;
    container.appendChild(div);
  });
  document.getElementById("checkout-total").innerText = `Total: $${total.toFixed(2)}`;
}

function cancelCheckout() {
  cart.forEach(item => {
    const stockItem = stock.find(s => s.name === item.name);
    if(stockItem) stockItem.stock += item.qty;
  });
  cart = [];
  renderProducts();
  renderCart();
  showScreen('pos-screen');
}

async function finishCheckout(payment) {
  const email = document.getElementById("customer-email").value;
  try {
    const res = await fetch(`${API_BASE}/pos`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "checkout", items: cart, payment, email })
    });
    const data = await res.json();
    if(data.success) {
      alert("‚úÖ Checkout complete! Receipt: " + data.receiptUrl);
      cart = [];
      renderProducts();
      renderCart();
      document.getElementById("customer-email").value = "";
      showScreen('pos-screen');
    } else {
      alert("‚ùå " + data.message);
    }
  } catch (err) {
    alert("Error contacting API.");
  }
}
</script>
</body>
</html>
