<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RekietaLabs POS - Loading</title>
<link rel="icon" href="IMG_0926.jpeg" type="image/jpeg">
<style>
  /* --- Global --- */
  body {
    margin: 0;
    font-family: 'Arial', sans-serif;
    background-color: #0a0a0a;
    color: #1753aa;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    padding: 20px;
  }

  button, input {
    font-family: inherit;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #1753aa;
    background-color: #111;
    color: #1753aa;
    padding: 10px;
    margin: 5px;
  }

  button:hover {
    background-color: #1753aa;
    color: #111;
    transition: 0.2s;
    cursor: pointer;
  }

  .hidden { display: none; }

  /* --- Loading Screen --- */
  #loading-screen {
    text-align: center;
    width: 100%;
  }

  #logo-circle {
    width: 100px;
    height: 100px;
    background: #1753aa;
    border-radius: 50%;
    margin: 0 auto 20px auto;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 36px;
    font-weight: bold;
    color: white;
  }

  h1, h2, h3 { margin: 10px; }

  /* --- POS Layout --- */
  #pos-screen {
    display: flex;
    gap: 30px;
    width: 100%;
    justify-content: center;
  }

  #product-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px;
    max-width: 600px;
  }

  .product-card {
    border: 1px solid #1753aa;
    border-radius: 10px;
    padding: 10px;
    background-color: #111;
    text-align: center;
  }

  .product-card button {
    width: 100%;
    margin-top: 5px;
  }

  #cart-panel {
    width: 300px;
    border: 1px solid #1753aa;
    border-radius: 10px;
    padding: 15px;
    background-color: #111;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #cart-panel h2 { margin-top: 0; }

  .cart-item { margin: 5px 0; }

  /* --- Checkout Modal --- */
  #checkout-screen {
    position: fixed;
    top: 0; left: 0; right:0; bottom:0;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
  }

  #checkout-modal {
    background-color: #111;
    border: 2px solid #1753aa;
    border-radius: 15px;
    padding: 20px;
    width: 400px;
    text-align: center;
  }

  #checkout-modal input {
    width: 90%;
  }

  #checkout-result {
    margin-top: 15px;
    color: #fff;
  }

</style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading-screen">
  <div id="logo-circle">RL</div>
  <h1>Hello! Welcome to RekietaLabs POS.</h1>
  <h3 id="subtitle">System Loading...</h3>
</div>

<!-- PIN Screen -->
<div id="pin-screen" class="hidden">
  <div id="logo-circle">RL</div>
  <h2>Enter Employee PIN</h2>
  <input type="password" id="pin-input" placeholder="Enter PIN">
  <div>
    <button onclick="login()">Login</button>
    <button onclick="signOut()">Sign Out</button>
  </div>
  <p id="pin-error" style="color:red;"></p>
</div>

<!-- POS Screen -->
<div id="pos-screen" class="hidden">
  <div id="product-list"></div>

  <div id="cart-panel">
    <h2>Cart</h2>
    <div id="cart"></div>
    <button onclick="checkout()">Checkout</button>
    <button onclick="signOut()">Sign Out</button>
  </div>
</div>

<!-- Checkout Modal -->
<div id="checkout-screen" class="hidden">
  <div id="checkout-modal">
    <h2>Checkout</h2>
    <label>Email (optional): <input type="email" id="customer-email"></label><br><br>
    <button onclick="finishCheckout('Card')">üí≥ Card</button>
    <button onclick="finishCheckout('Cash')">üíµ Cash</button>
    <button onclick="cancelCheckout()">‚ùå Cancel</button>
    <p id="checkout-result"></p>
  </div>
</div>

<script>
  const API_BASE = window.location.hostname.includes("localhost")
    ? "http://localhost:10000"
    : "https://api.rekietalabs.com";

  let cart = [];
  let stock = [];

  // --- Startup ---
  setTimeout(() => {
    document.getElementById("loading-screen").classList.add("hidden");
    document.getElementById("pin-screen").classList.remove("hidden");
    document.title = "RekietaLabs POS - Login";
  }, 3000);

  // --- Load Stock ---
  async function loadStock() {
    try {
      const res = await fetch(`${API_BASE}/pos-stock.json`);
      stock = await res.json();
      if (!document.getElementById("pos-screen").classList.contains("hidden")) renderProducts();
    } catch (err) {
      console.error(err);
      alert("Error loading stock.");
    }
  }

  // --- PIN Login ---
  async function login() {
    const pin = document.getElementById("pin-input").value;
    try {
      const res = await fetch(`${API_BASE}/pos`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "validate-pin", pin })
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById("pin-screen").classList.add("hidden");
        document.getElementById("pos-screen").classList.remove("hidden");
        cart = [];
        await loadStock();
        document.title = "RekietaLabs POS - Active";
      } else {
        document.getElementById("pin-error").innerText = "Invalid PIN.";
      }
    } catch (err) {
      document.getElementById("pin-error").innerText = "Error contacting API.";
    }
  }

  function signOut() {
    cart = [];
    document.getElementById("pos-screen").classList.add("hidden");
    document.getElementById("checkout-screen").classList.add("hidden");
    document.getElementById("pin-screen").classList.remove("hidden");
    document.getElementById("pin-input").value = "";
    document.getElementById("pin-error").innerText = "";
    document.title = "RekietaLabs POS - Login";
  }

  // --- Products ---
  function renderProducts() {
    const container = document.getElementById("product-list");
    container.innerHTML = "";
    stock.forEach((item, idx) => {
      const card = document.createElement("div");
      card.className = "product-card";
      card.innerHTML = `
        <h3>${item.name}</h3>
        <p>$${item.price.toFixed(2)}</p>
        <p>Stock: ${item.stock}</p>
        <button onclick="addToCart(${idx})">Add to Cart</button>
      `;
      container.appendChild(card);
    });
  }

  function addToCart(idx) {
    const product = stock[idx];
    if (product.stock <= 0) return alert("Out of stock!");

    const existing = cart.find(c => c.id === product.id);
    if (existing) existing.qty++;
    else cart.push({ id: product.id, name: product.name, qty: 1 });

    renderCart();
  }

  function renderCart() {
    const container = document.getElementById("cart");
    container.innerHTML = "";
    cart.forEach(item => {
      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerText = `${item.name} x ${item.qty}`;
      container.appendChild(div);
    });
  }

  // --- Checkout ---
  function checkout() {
    if (cart.length === 0) return alert("Cart is empty!");
    document.getElementById("checkout-screen").classList.remove("hidden");
  }

  function cancelCheckout() {
    document.getElementById("checkout-screen").classList.add("hidden");
  }

  async function finishCheckout(payment) {
    const email = document.getElementById("customer-email").value;
    try {
      const res = await fetch(`${API_BASE}/pos`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "checkout", items: cart, email, payment })
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById("checkout-result").innerHTML =
          `‚úÖ Success! <a href="${data.receiptUrl}" target="_blank">View Receipt</a>`;
        
        // Update local stock after successful checkout
        cart.forEach(item => {
          const prod = stock.find(p => p.id === item.id);
          if (prod) prod.stock -= item.qty;
        });

        cart = [];
        renderCart();
        renderProducts();

        // Return to POS after 3s
        setTimeout(() => {
          document.getElementById("checkout-screen").classList.add("hidden");
          document.getElementById("customer-email").value = "";
          document.getElementById("checkout-result").innerText = "";
        }, 3000);
      } else {
        document.getElementById("checkout-result").innerText = "‚ùå " + data.message;
      }
    } catch (err) {
      document.getElementById("checkout-result").innerText = "Error contacting API.";
    }
  }

</script>
</body>
</html>
