<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RekietaLabs POS - Loading</title>
  <link rel="icon" href="IMG_0926.jpeg" type="image/jpeg">
  <style>
    :root { --brand-color: #1753aa; }
    body {
      font-family: Arial, sans-serif;
      background: #0a0a0a;
      color: var(--brand-color);
      text-align: center;
      padding: 50px;
    }
    .hidden { display: none; }
    input, button {
      padding: 10px;
      margin: 10px;
      border-radius: 8px;
      border: 1px solid var(--brand-color);
      background: #111;
      color: var(--brand-color);
    }
    button { cursor: pointer; }
    #cart { margin-top: 20px; }
    .cart-item { margin: 5px 0; }
    .low-stock { color: red; font-weight: bold; }
    #logo { width: 120px; height: 120px; border-radius: 50%; margin: 20px auto; display: block; }
    #signout-btn { margin-top: 20px; background: #111; border: 1px solid var(--brand-color); color: var(--brand-color); }
  </style>
</head>
<body>
  <img id="logo" src="IMG_0926.jpeg" alt="RekietaLabs Logo">
  <h1 id="main-title">Hello! Welcome to RekietaLabs POS.</h1>
  <h3 id="subtitle">System Loading...</h3>

  <div id="pin-screen" class="hidden">
    <h2>Enter Employee PIN</h2>
    <input type="password" id="pin-input" placeholder="Enter PIN">
    <button onclick="login()">Login</button>
    <p id="pin-error" style="color:red;"></p>
  </div>

  <div id="pos-screen" class="hidden">
    <h2>Products</h2>
    <div id="products"></div>

    <h2>Cart</h2>
    <div id="cart"></div>

    <button onclick="checkout()">Checkout</button>
    <button id="signout-btn" onclick="signOut()">Sign Out</button>
  </div>

  <div id="checkout-screen" class="hidden">
    <h2>Checkout</h2>
    <label>Email (optional): <input type="email" id="customer-email"></label><br>
    <button onclick="finishCheckout('Card')">💳 Card</button>
    <button onclick="finishCheckout('Cash')">💵 Cash</button>
    <p id="checkout-result"></p>
  </div>

<script>
  // --- Config ---
  const pins = ["7606", "4646"];
  let stock = [];
  let tempStock = [];
  let cart = [];

  // --- Load screen ---
  setTimeout(() => {
    document.title = "RekietaLabs POS - Login";
    document.getElementById("subtitle").classList.add("hidden");
    document.getElementById("pin-screen").classList.remove("hidden");
    loadStock();
  }, 2000);

  // --- Load stock from local JSON ---
  async function loadStock() {
    try {
      const res = await fetch("pos-stock.json");
      stock = await res.json();
      tempStock = JSON.parse(JSON.stringify(stock));
    } catch(err) {
      document.getElementById("pin-error").innerText = "Error loading stock.";
      console.error(err);
    }
  }

  // --- Login ---
  function login() {
    const pin = document.getElementById("pin-input").value;
    if(pins.includes(pin)) {
      document.title = "RekietaLabs POS - Active";
      document.getElementById("pin-screen").classList.add("hidden");
      document.getElementById("pos-screen").classList.remove("hidden");
      cart = [];
      tempStock = JSON.parse(JSON.stringify(stock));
      renderProducts();
      renderCart();
    } else {
      document.getElementById("pin-error").innerText = "Invalid PIN.";
    }
  }

  // --- Sign out ---
  function signOut() {
    document.getElementById("pos-screen").classList.add("hidden");
    document.getElementById("pin-screen").classList.remove("hidden");
    document.getElementById("pin-input").value = "";
    cart = [];
    tempStock = JSON.parse(JSON.stringify(stock));
    document.getElementById("checkout-result").innerText = "";
  }

  // --- Render products ---
  function renderProducts() {
    const container = document.getElementById("products");
    container.innerHTML = "";
    tempStock.forEach((item, idx) => {
      const btn = document.createElement("button");
      let label = `${item.name} - $${item.price.toFixed(2)} (${item.stock} left)`;
      if(item.stock <= 1) label += " ⚠️ Low Stock";
      btn.innerText = label;
      btn.onclick = () => addToCart(idx);
      container.appendChild(btn);
    });
  }

  // --- Cart functions ---
  function addToCart(idx) {
    const item = tempStock[idx];
    if(item.stock <= 0) return alert("Out of stock!");
    item.stock -= 1;

    const existing = cart.find(c => c.id === item.id);
    if(existing) existing.qty++;
    else cart.push({ ...item, qty: 1 });

    renderCart();
    renderProducts();
  }

  function renderCart() {
    const container = document.getElementById("cart");
    container.innerHTML = "";
    cart.forEach(item => {
      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerText = `${item.name} x ${item.qty}`;
      container.appendChild(div);
    });
  }

  // --- Checkout ---
  function checkout() {
    if(cart.length === 0) return alert("Cart is empty!");
    document.getElementById("pos-screen").classList.add("hidden");
    document.getElementById("checkout-screen").classList.remove("hidden");
    document.title = "RekietaLabs POS - Checkout";
  }

  function finishCheckout(payment) {
    const email = document.getElementById("customer-email").value;
    // Generate fake receipt link (your separate receipt system will handle real email)
    const receiptId = Math.random().toString(36).substring(2,10);
    const receiptUrl = `https://receipts.rekietalabs.com/market/${receiptId}`;

    // Update stock only after checkout
    cart.forEach(c => {
      const prod = stock.find(p => p.id === c.id);
      if(prod) prod.stock -= c.qty;
    });

    // Clear temp stock & cart for next order
    tempStock = JSON.parse(JSON.stringify(stock));
    cart = [];
    renderProducts();
    renderCart();

    // Show result
    document.getElementById("checkout-result").innerHTML = `✅ Success! <a href="${receiptUrl}" target="_blank">View Receipt</a>`;
    
    // Back to POS screen after 3s
    setTimeout(() => {
      document.getElementById("checkout-screen").classList.add("hidden");
      document.getElementById("pos-screen").classList.remove("hidden");
      document.getElementById("checkout-result").innerText = "";
      document.getElementById("customer-email").value = "";
      document.title = "RekietaLabs POS - Active";
    }, 3000);
  }
</script>
</body>
</html>
