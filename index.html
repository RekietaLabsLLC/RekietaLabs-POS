<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loading - RekietaLabs POS</title>
  <link rel="icon" href="IMG_0926.jpeg" type="image/jpeg">
  <!-- Font Awesome for payment icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    /* --- General Styles --- */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #eee;
    }
    h1, h3 {
      text-align: center;
    }
    /* --- Loading Screen --- */
    #loading-screen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #loading-screen .logo {
      width: 200px;
      margin-bottom: 20px;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #1753aa;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* --- PIN Modal --- */
    #pin-modal {
      display: none;
      position: fixed;
      top: 0; left:0;
      width: 100%; height:100%;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
    }
    #pin-modal .modal-content {
      background: #1e1e1e;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      width: 300px;
    }
    #pin-modal input[type="password"] {
      width: 80%;
      padding: 10px;
      font-size: 16px;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid #555;
      background: #222;
      color: #eee;
    }
    #pin-modal button {
      padding: 10px 20px;
      font-size: 16px;
      background: #1753aa;
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
    }
    #pin-error { color: #ff5555; margin-top: 10px; display: none; }
    /* --- POS Dashboard --- */
    #pos-dashboard {
      display: none;
      padding: 20px;
    }
    #products {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }
    .product {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 8px;
      width: 200px;
      text-align: center;
    }
    .product button {
      margin-top: 10px;
      padding: 8px 12px;
      background: #1753aa;
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
    }
    #cart {
      margin-top: 30px;
      background: #1a1a1a;
      padding: 15px;
      border-radius: 8px;
    }
    #cart h2 { text-align: center; }
    .cart-item {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }
    .cart-item button {
      background: #ff5555;
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      padding: 2px 6px;
    }
    #checkout-btn {
      margin-top: 15px;
      width: 100%;
      padding: 10px;
      background: #1753aa;
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
    }
    /* --- Checkout Modal --- */
    #checkout-modal {
      display: none;
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
    }
    #checkout-modal .modal-content {
      background: #1e1e1e;
      padding: 30px;
      border-radius: 10px;
      width: 350px;
      text-align: center;
    }
    #checkout-modal input[type="email"] {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid #555;
      background: #222;
      color: #eee;
    }
    .payment-option {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
      cursor: pointer;
    }
    .payment-option input { transform: scale(1.5); }
    /* --- QR Code Modal --- */
    #qr-modal {
      display: none;
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #qr-modal img.logo-qr {
      width: 120px;
      margin-bottom: 20px;
    }
    #qr-modal canvas { margin-top: 20px; }
  </style>
</head>
<body>

  <!-- Loading Screen -->
  <div id="loading-screen">
    <img src="IMG_0926.jpeg" alt="RekietaLabs Logo" class="logo">
    <h1>Hello! Welcome to RekietaLabs POS.</h1>
    <h3>System Loading...</h3>
    <div class="spinner"></div>
  </div>

  <!-- PIN Modal -->
  <div id="pin-modal">
    <div class="modal-content">
      <h2>Employee Login</h2>
      <input type="password" id="pin-input" placeholder="Enter PIN">
      <br>
      <button id="pin-submit">Login</button>
      <div id="pin-error">Invalid PIN. Try again.</div>
    </div>
  </div>

  <!-- POS Dashboard -->
  <div id="pos-dashboard">
    <h1>RekietaLabs POS</h1>
    <div id="products"></div>
    <div id="cart">
      <h2>Cart</h2>
      <div id="cart-items"></div>
      <div>Total: $<span id="cart-total">0.00</span></div>
      <button id="checkout-btn">Checkout</button>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkout-modal">
    <div class="modal-content">
      <h2>Checkout</h2>
      <div class="payment-option">
        <input type="radio" name="payment" id="payment-card" value="Card" checked>
        <label for="payment-card"><i class="far fa-credit-card"></i> Card</label>
      </div>
      <div class="payment-option">
        <input type="radio" name="payment" id="payment-cash" value="Cash">
        <label for="payment-cash"><i class="far fa-money-bill-wave"></i> Cash</label>
      </div>
      <input type="email" id="customer-email" placeholder="Customer Email (optional)">
      <br>
      <button id="checkout-confirm">Confirm</button>
    </div>
  </div>

  <!-- QR Code Modal -->
  <div id="qr-modal">
    <img src="IMG_0926.jpeg" alt="RekietaLabs Logo" class="logo-qr">
    <h2>Receipt Generated</h2>
    <div id="qr-code"></div>
  </div>

  <!-- QR Code JS -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <script>
    // --- Tab Title Update ---
    function setTab(title) { document.title = title + " - RekietaLabs POS"; }

    // --- Loading Screen ---
    setTab("Loading");
    setTimeout(() => {
      document.getElementById('loading-screen').style.display = "none";
      showPinModal();
    }, 5000);

    // --- PIN Login ---
    function showPinModal() {
      setTab("Employee Login");
      const modal = document.getElementById('pin-modal');
      modal.style.display = "flex";
      document.getElementById('pin-submit').onclick = async () => {
        const pin = document.getElementById('pin-input').value;
        try {
          const res = await fetch('https://api.rekietalabs.com/validate-pin', {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ pin })
          });
          const data = await res.json();
          if(data.success){
            modal.style.display = "none";
            showDashboard();
          } else {
            document.getElementById('pin-error').style.display = "block";
          }
        } catch(e) {
          alert("Error contacting API.");
        }
      }
    }

    // --- POS Dashboard ---
    let products = [];
    let cart = [];

    async function showDashboard() {
      setTab("POS Dashboard");
      document.getElementById('pos-dashboard').style.display = "block";
      // Load products from pos-stock.json
      try {
        const res = await fetch('pos-stock.json');
        products = await res.json();
        renderProducts();
      } catch(e) {
        alert("Failed to load stock.");
      }
    }

    function renderProducts() {
      const container = document.getElementById('products');
      container.innerHTML = "";
      products.forEach(p => {
        const div = document.createElement('div');
        div.className = "product";
        div.innerHTML = `
          <h3>${p.name}</h3>
          <div>Price: $${p.price}</div>
          <div>Stock: <span class="stock">${p.stock}</span></div>
          <button ${p.stock === 0 ? "disabled" : ""}>Add to Cart</button>
        `;
        div.querySelector('button').onclick = () => addToCart(p.id);
        container.appendChild(div);
      });
    }

    function addToCart(id) {
      const product = products.find(p=>p.id===id);
      if(!product || product.stock <=0) return;
      const item = cart.find(c=>c.id===id);
      if(item){
        if(item.qty < product.stock){
          item.qty++;
        }
      } else {
        cart.push({id:id, qty:1});
      }
      renderCart();
    }

    function renderCart() {
      const container = document.getElementById('cart-items');
      container.innerHTML = "";
      let total = 0;
      cart.forEach(item=>{
        const prod = products.find(p=>p.id===item.id);
        total += prod.price * item.qty;
        const div = document.createElement('div');
        div.className = "cart-item";
        div.innerHTML = `
          <span>${prod.name} x ${item.qty} - $${prod.price*item.qty}</span>
          <button>&times;</button>
        `;
        div.querySelector('button').onclick = () => {
          item.qty--;
          if(item.qty<=0) cart = cart.filter(c=>c.id!==item.id);
          renderCart();
        }
        container.appendChild(div);
      });
      document.getElementById('cart-total').innerText = total.toFixed(2);
    }

    // --- Checkout Modal ---
    document.getElementById('checkout-btn').onclick = () => {
      setTab("Checkout");
      document.getElementById('checkout-modal').style.display = "flex";
    }

    document.getElementById('checkout-confirm').onclick = async () => {
      const payment = document.querySelector('input[name="payment"]:checked').value;
      const email = document.getElementById('customer-email').value;
      const orderItems = cart.map(c=>{
        const prod = products.find(p=>p.id===c.id);
        return { name: prod.name, qty: c.qty, price: prod.price };
      });
      const total = orderItems.reduce((acc,i)=>acc+i.price*i.qty,0);
      try {
        const res = await fetch('https://api.rekietalabs.com/market-checkout', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ items: orderItems, payment, email })
        });
        const data = await res.json();
        if(data.success){
          // update local stock
          orderItems.forEach(i=>{
            const prod = products.find(p=>p.name===i.name);
            if(prod) prod.stock -= i.qty;
          });
          renderProducts();
          cart = [];
          renderCart();
          showQR(data.receiptUrl);
          document.getElementById('checkout-modal').style.display = "none";
        } else {
          alert("Checkout failed: "+data.message);
        }
      } catch(e){
        alert("Error contacting API.");
      }
    }

    function showQR(url) {
      setTab("Receipt Generated");
      const modal = document.getElementById('qr-modal');
      modal.style.display = "flex";
      const qrContainer = document.getElementById('qr-code');
      qrContainer.innerHTML = "";
      QRCode.toCanvas(qrContainer, url, { width: 200 }, function (error) {
        if (error) console.error(error);
      });
    }
  </script>
</body>
</html>
